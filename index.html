<!doctype html>
<meta charset="utf-8">
<title>Borrow Query</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  :root { font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans", "Helvetica Neue", Arial; }
  body { margin: 16px; }
  .row { display: flex; flex-wrap: wrap; align-items: center; gap: 8px; }
  label { display: inline-flex; align-items: center; gap: 6px; }
  select, button { padding: 6px 10px; }
  button { cursor: pointer; }
  #msg { margin-top: 10px; color: #444; }
  #result { margin-top: 14px; font-weight: 600; }
  table { border-collapse: collapse; width: 100%; margin-top: 12px; }
  th, td { border: 1px solid #ddd; padding: 6px 8px; text-align: left; }
  th { background: #f5f5f5; }
</style>

<div class="row">
  <label>學院 <select id="college"></select></label>
  <label>學系 <select id="dept"></select></label>
  <label>讀者類型 <select id="reader"></select></label>
  <button id="btnSum">查冊次</button>
  <button id="btnUsers">查人次</button>
  <button id="btnList">清單</button>
  <button id="btnCsv">匯出CSV</button>
</div>

<div id="msg"></div>
<div id="result"></div>
<div id="tableWrap"></div>

<script>
// ===== Config =====
const API = new URLSearchParams(location.search).get("api")
  || "https://sculib.app.n8n.cloud/webhook/borrow-stats";

const el = id => document.getElementById(id);
const selects = { college: el("college"), dept: el("dept"), reader: el("reader") };
const msg = el("msg"), result = el("result"), tableWrap = el("tableWrap");

let rowsCache = []; // for CSV export

function setMessage(t){ msg.textContent = t || ""; }
function setResult(t){ result.textContent = t || ""; }
function clearTable(){ tableWrap.innerHTML = ""; }
function showError(e){ setMessage("發生錯誤：" + e); console.error(e); }

function currentParams(){
  const p = new URLSearchParams();
  const c = selects.college.value, d = selects.dept.value, r = selects.reader.value;
  if (c) p.set("college", c);
  if (d) p.set("dept", d);
  if (r) p.set("readerType", r);
  return p;
}

async function callAPI(params){
  const url = API + "?" + params.toString();
  const res = await fetch(url, { mode: "cors" });
  if (!res.ok) throw new Error("HTTP " + res.status);
  return res.json();
}

function fillSelect(sel, arr){
  const cur = sel.value;
  const opts = ['<option value=""></option>']
    .concat((arr || []).map(v => `<option>${v}</option>`))
    .join("");
  sel.innerHTML = opts;
  if (cur && arr && arr.includes(cur)) sel.value = cur;
}

// 移除 "NA" 或 "NA, " 前綴
const cleanCollege = s => String(s || "").replace(/^NA\s*,\s*/i, "").trim();

async function loadOptions(){
  try{
    setMessage("載入選項中…");
    const p = currentParams(); p.set("view", "options");
    const data = await callAPI(p);

    const rawCol = (data?.options?.colleges || []);
    const colleges = Array.from(new Set(
      rawCol
        .filter(x => String(x).toUpperCase() !== "NA")
        .map(cleanCollege)
        .filter(x => x !== "")
    )).sort();

    const depts   = (data?.options?.depts || []).filter(x => x !== "");
    const readers = (data?.options?.readers || []).filter(x => x !== "");

    fillSelect(selects.college, colleges);
    fillSelect(selects.dept,    depts);
    fillSelect(selects.reader,  readers);
    setMessage("");
  }catch(e){ showError("選項取得失敗，請確認 CORS 與 API 是否可用。詳見主控台。"); }
}

async function querySummary(metric){
  try{
    setMessage("查詢中…"); setResult(""); clearTable();
    const p = currentParams(); p.set("view","summary"); p.set("metric", metric);
    const data = await callAPI(p);
    setResult((metric === "users" ? "人次：" : "冊次：") + (data.count ?? 0) + "（筆數：" + (data.matchedRows ?? 0) + "）");
    setMessage("");
  }catch(e){ showError(e); }
}

// ---- Table rendering with Chinese headers and requested order ----
const COLUMNS = [
  { key: "title",    label: "題名" },
  { key: "callno",   label: "索書號" },
  { key: "barcode",  label: "條碼號" },         // 後端未提供則空白
  { key: "author",   label: "借閱者姓名" },
  { key: "college",  label: "學院" },
  { key: "dept",     label: "學系" },
  { key: "reader",   label: "類型" },
  { key: "userId",   label: "學號/證號" },
  { key: "loanDate", label: "借閱日期" },
  { key: "copies",   label: "冊次" },
];

function renderTable(rows){
  rowsCache = rows || [];
  if (!rowsCache.length){ clearTable(); return; }
  const thead = "<thead><tr>" + COLUMNS.map(c => "<th>" + c.label + "</th>").join("") + "</tr></thead>";
  const tbody = "<tbody>" + rowsCache.map(r =>
    "<tr>" + COLUMNS.map(c => "<td>" + (r[c.key] ?? "") + "</td>").join("") + "</tr>"
  ).join("") + "</tbody>";
  tableWrap.innerHTML = "<table>" + thead + tbody + "</table>";
}

async function queryList(){
  try{
    setMessage("查詢中…"); setResult(""); clearTable();
    const p = currentParams(); p.set("view","list"); p.set("limit","500"); p.set("offset","0");
    const data = await callAPI(p);
    setResult("符合筆數：" + (data.totalMatched ?? 0));
    renderTable((data.rows || []).map(r => ({ ...r, barcode: r.barcode || "" })));
    setMessage("");
  }catch(e){ showError(e); }
}

// ---- CSV export ----
function toCsvValue(v){
  const s = (v == null ? "" : String(v)).replace(/"/g, '""');
  return `"${s}"`;
}
function downloadCsv(){
  try{
    if (!rowsCache.length){ setMessage("尚無清單，請先按『清單』查詢。"); return; }
    const header = COLUMNS.map(c => c.label).join(",");
    const lines = rowsCache.map(r => COLUMNS.map(c => toCsvValue(r[c.key] ?? "")).join(","));
    const csv = "\ufeff" + [header].concat(lines).join("\r\n"); // BOM for Excel
    const blob = new Blob([csv], { type: "text/csv;charset=utf-8" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "borrow-list.csv";
    document.body.appendChild(a);
    a.click();
    URL.revokeObjectURL(a.href);
    a.remove();
  }catch(e){ showError(e); }
}

document.getElementById("btnSum").addEventListener("click", () => querySummary("copies"));
document.getElementById("btnUsers").addEventListener("click", () => querySummary("users"));
document.getElementById("btnList").addEventListener("click", () => queryList());
document.getElementById("btnCsv").addEventListener("click", () => downloadCsv());

selects.college.addEventListener("change", () => loadOptions());
selects.dept.addEventListener("change", () => loadOptions());
selects.reader.addEventListener("change", () => loadOptions());

loadOptions();
</script>
