<!doctype html>
<meta charset="utf-8">
<title>Borrow Query</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  :root { font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans", "Helvetica Neue", Arial; }
  body { margin: 16px; }
  .row { display: flex; flex-wrap: wrap; align-items: center; gap: 8px; }
  label { display: inline-flex; align-items: center; gap: 6px; }
  select, button { padding: 6px 10px; }
  button { cursor: pointer; }
  #msg { margin-top: 10px; color: #444; }
  #result { margin-top: 14px; font-weight: 600; }
  table { border-collapse: collapse; width: 100%; margin-top: 12px; }
  th, td { border: 1px solid #ddd; padding: 6px 8px; text-align: left; }
  th { background: #f5f5f5; }
  pre { white-space: pre-wrap; word-break: break-word; background: #fafafa; border: 1px solid #eee; padding: 10px; }
</style>

<div class="row">
  <label>學院 <select id="college"></select></label>
  <label>學系 <select id="dept"></select></label>
  <label>讀者類型 <select id="reader"></select></label>
  <button id="btnSum">查冊次</button>
  <button id="btnUsers">查人次</button>
  <button id="btnList">清單</button>
</div>

<div id="msg"></div>
<div id="result"></div>
<div id="tableWrap"></div>
<pre id="debug" style="display:none"></pre>

<script>
// ===== Config =====
// 預設使用正式 API，可用 ?api=... 覆蓋
const API = new URLSearchParams(location.search).get("api")
  || "https://sculib.app.n8n.cloud/webhook/borrow-stats";

const el = id => document.getElementById(id);
const selects = { college: el("college"), dept: el("dept"), reader: el("reader") };
const msg = el("msg"), result = el("result"), tableWrap = el("tableWrap");

function setMessage(t){ msg.textContent = t || ""; }
function setResult(t){ result.textContent = t || ""; }
function clearTable(){ tableWrap.innerHTML = ""; }
function showError(e){ setMessage("發生錯誤：" + e); console.error(e); }

function currentParams(){
  const p = new URLSearchParams();
  const c = selects.college.value, d = selects.dept.value, r = selects.reader.value;
  if (c) p.set("college", c);
  if (d) p.set("dept", d);
  if (r) p.set("readerType", r);
  return p;
}

async function callAPI(params){
  const url = API + "?" + params.toString();
  const res = await fetch(url, { mode: "cors" });
  if (!res.ok) throw new Error("HTTP " + res.status);
  return res.json();
}

function fillSelect(sel, arr){
  const cur = sel.value;
  const opts = ['<option value=""></option>']
    .concat((arr || []).map(v => `<option>${v}</option>`))
    .join("");
  sel.innerHTML = opts;
  if (cur && arr && arr.includes(cur)) sel.value = cur;
}

// 移除 "NA" 或 "NA, " 前綴
const cleanCollege = s => String(s || "").replace(/^NA\s*,\s*/i, "").trim();

async function loadOptions(){
  try{
    setMessage("載入選項中…");
    const p = currentParams(); p.set("view", "options");
    const data = await callAPI(p);

    const rawCol = (data?.options?.colleges || []);
    const colleges = Array.from(new Set(
      rawCol
        .filter(x => String(x).toUpperCase() !== "NA")
        .map(cleanCollege)
        .filter(x => x !== "")
    )).sort();

    const depts   = (data?.options?.depts || []).filter(x => x !== "");
    const readers = (data?.options?.readers || []).filter(x => x !== "");

    fillSelect(selects.college, colleges);
    fillSelect(selects.dept,    depts);
    fillSelect(selects.reader,  readers);
    setMessage("");
  }catch(e){ showError("選項取得失敗，請確認 CORS 與 API 是否可用。詳見主控台。"); }
}

async function querySummary(metric){
  try{
    setMessage("查詢中…"); setResult(""); clearTable();
    const p = currentParams(); p.set("view","summary"); p.set("metric", metric);
    const data = await callAPI(p);
    setResult((metric === "users" ? "人次：" : "冊次：") + (data.count ?? 0) + "（筆數：" + (data.matchedRows ?? 0) + "）");
    setMessage("");
  }catch(e){ showError(e); }
}

function renderTable(rows){
  if (!rows?.length){ clearTable(); return; }
  const cols = ["title","author","college","dept","reader","userId","loanDate","callno","copies"];
  const thead = "<thead><tr>" + cols.map(c => "<th>" + c + "</th>").join("") + "</tr></thead>";
  const tbody = "<tbody>" + rows.map(r =>
    "<tr>" + cols.map(c => "<td>" + (r[c] ?? "") + "</td>").join("") + "</tr>"
  ).join("") + "</tbody>";
  tableWrap.innerHTML = "<table>" + thead + tbody + "</table>";
}

async function queryList(){
  try{
    setMessage("查詢中…"); setResult(""); clearTable();
    const p = currentParams(); p.set("view","list"); p.set("limit","50"); p.set("offset","0");
    const data = await callAPI(p);
    setResult("符合筆數：" + (data.totalMatched ?? 0));
    renderTable(data.rows || []);
    setMessage("");
  }catch(e){ showError(e); }
}

document.getElementById("btnSum").addEventListener("click", () => querySummary("copies"));
document.getElementById("btnUsers").addEventListener("click", () => querySummary("users"));
document.getElementById("btnList").addEventListener("click", () => queryList());

selects.college.addEventListener("change", () => loadOptions());
selects.dept.addEventListener("change", () => loadOptions());
selects.reader.addEventListener("change", () => loadOptions());

loadOptions();
</script>
