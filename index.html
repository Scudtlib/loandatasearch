<!doctype html>
<meta charset="utf-8">
<title>借閱查詢（一次載入→本地篩選）</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  :root{font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans","Helvetica Neue",Arial}
  body{margin:16px}
  .row{display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin-bottom:8px}
  label{display:inline-flex;align-items:center;gap:6px}
  select,button{padding:6px 10px;min-width:140px}
  button{cursor:pointer}
  #status{color:#555}
  #result{margin-top:10px;font-weight:600}
  table{border-collapse:collapse;width:100%;margin-top:12px}
  th,td{border:1px solid #ddd;padding:6px 8px;text-align:left}
  th{background:#f5f5f5}
</style>

<h3>借閱查詢（先載入一次資料→後續本地篩選）</h3>

<div class="row">
  <button id="btnLoad">載入/更新資料</button>
  <button id="btnClear">清除快取</button>
  <span id="status"></span>
</div>

<div class="row">
  <label>學院 <select id="college"></select></label>
  <label>學系 <select id="dept"></select></label>
  <label>讀者類型 <select id="reader"></select></label>
  <button id="btnSum">查冊次</button>
  <button id="btnUsers">查人次</button>
  <button id="btnList">清單</button>
  <button id="btnCsv">匯出CSV</button>
  <button id="btnReset">重置條件</button>
</div>

<div id="result"></div>
<div id="tableWrap"></div>

<script>
const API = new URLSearchParams(location.search).get("api")
  || "https://sculib.app.n8n.cloud/webhook/borrow-stats"; // 後端 view=list 一次回全部
const CACHE_KEY = "borrowCache::" + API;
const CACHE_TTL_MS = 6 * 60 * 60 * 1000;

const selects = {
  college: document.getElementById("college"),
  dept: document.getElementById("dept"),
  reader: document.getElementById("reader")
};
const statusEl = document.getElementById("status");
const resultEl = document.getElementById("result");
const tableWrap = document.getElementById("tableWrap");

let DATA = [], VIEW = [];

const COLS = [
  { key:"title",    label:"題名" },
  { key:"callno",   label:"索書號" },
  { key:"author",   label:"借閱者姓名" },
  { key:"college",  label:"學院" },
  { key:"dept",     label:"學系" },
  { key:"reader",   label:"類型" },
  { key:"userId",   label:"學號/證號" },
  { key:"loanDate", label:"借閱日期" },
  { key:"copies",   label:"冊次" },
];

const S=v=>v==null?"":String(v);
const unify=s=>S(s).replace(/\u3000/g," ").replace(/\u00A0/g," ").trim();
const norm=s=>unify(s).replace(/\s+/g,"");
const matchInc=(qv,dv)=>!qv||norm(dv).includes(norm(qv));
const uniq=a=>Array.from(new Set(a.filter(Boolean))).sort();

function setStatus(t){statusEl.textContent=t||""}
function setResult(t){resultEl.textContent=t||""}
function clearTable(){tableWrap.innerHTML=""}
function fillSelect(sel,arr){
  const cur=sel.value;
  sel.innerHTML=['<option value=""></option>'].concat(arr.map(x=>`<option>${x}</option>`)).join("");
  if(cur&&arr.includes(cur)) sel.value=cur;
}

async function loadOptions(){
  // 先用 API options，失敗才用本地推算；保留 NA
  try{
    const r=await fetch(API+"?view=options",{mode:"cors"});
    if(!r.ok) throw 0;
    const d=await r.json();
    fillSelect(selects.college, uniq((d?.options?.colleges)||[]));
    fillSelect(selects.dept,    uniq((d?.options?.depts)||[]));
    fillSelect(selects.reader,  uniq((d?.options?.readers)||[]));
    return;
  }catch{
    fillSelect(selects.college, uniq(DATA.map(r=>r.college)));
    fillSelect(selects.dept,    uniq(DATA.map(r=>r.dept)));
    fillSelect(selects.reader,  uniq(DATA.map(r=>r.reader)));
  }
}

// 單次抓全量（後端需保證 view=list 回全部 rows）
async function loadAll(){
  setStatus("下載資料中…");
  const res = await fetch(API+"?view=list", {mode:"cors"});
  if(!res.ok) throw new Error("HTTP "+res.status);
  const {rows=[]} = await res.json();
  DATA = rows;
  localStorage.setItem(CACHE_KEY, JSON.stringify({ts:Date.now(), rows:DATA}));
  await loadOptions();
  setStatus(`已載入 ${DATA.length} 筆（已快取）`);
}

async function tryLoadCache(){
  const raw=localStorage.getItem(CACHE_KEY);
  if(!raw) return false;
  try{
    const {ts,rows}=JSON.parse(raw);
    if(!Array.isArray(rows)) return false;
    if(Date.now()-ts> CACHE_TTL_MS) return false;
    DATA=rows;
    await loadOptions();
    setStatus(`已從快取載入 ${DATA.length} 筆（${new Date(ts).toLocaleString()}）`);
    return true;
  }catch{return false;}
}

function buildFiltered(){
  return DATA.filter(r =>
    matchInc(selects.college.value, r.college) &&
    matchInc(selects.dept.value,    r.dept) &&
    matchInc(selects.reader.value,  r.reader)
  );
}
function renderTable(rows){
  if(!rows.length){clearTable();return;}
  const thead="<thead><tr>"+COLS.map(c=>"<th>"+c.label+"</th>").join("")+"</tr></thead>";
  const tbody="<tbody>"+rows.map(r=>"<tr>"+COLS.map(c=>"<td>"+S(r[c.key])+"</td>").join("")+"</tr>").join("")+"</tbody>";
  tableWrap.innerHTML="<table>"+thead+tbody+"</table>";
}
function toCsv(rows){
  const header=COLS.map(c=>c.label).join(",");
  const esc=v=>`"${S(v).replace(/"/g,'""')}"`;
  const lines=rows.map(r=>COLS.map(c=>esc(r[c.key])).join(","));
  return "\ufeff"+[header].concat(lines).join("\r\n");
}

// 綁定
document.getElementById("btnLoad").onclick=async()=>{
  setResult("");clearTable();
  try{await loadAll();}catch(e){setStatus("下載失敗："+e.message);}
};
document.getElementById("btnClear").onclick=()=>{
  localStorage.removeItem(CACHE_KEY);
  setStatus("已清除快取，請重新『載入/更新資料』。");
};
document.getElementById("btnReset").onclick=()=>{selects.college.value="";selects.dept.value="";selects.reader.value="";setResult("");clearTable();};
document.getElementById("btnSum").onclick=()=>{VIEW=buildFiltered();const total=VIEW.reduce((a,r)=>a+(Number(r.copies)||0),0);renderTable([]);setResult(`冊次：${total}（筆數：${VIEW.length}）`);};
document.getElementById("btnUsers").onclick=()=>{VIEW=buildFiltered();const ids=new Set(VIEW.map(r=>S(r.userId)).filter(Boolean));renderTable([]);setResult(`人次：${ids.size}（筆數：${VIEW.length}）`);};
document.getElementById("btnList").onclick=()=>{VIEW=buildFiltered();renderTable(VIEW);setResult(`符合筆數：${VIEW.length}`);};
document.getElementById("btnCsv").onclick=()=>{if(!VIEW.length){setStatus("請先按『清單』查詢。");return;}const csv=toCsv(VIEW);const blob=new Blob([csv],{type:"text/csv;charset=utf-8"});const a=document.createElement("a");a.href=URL.createObjectURL(blob);a.download="borrow-list.csv";document.body.appendChild(a);a.click();URL.revokeObjectURL(a.href);a.remove();};

// 啟動
tryLoadCache().then(ok=>{if(!ok) setStatus("尚未載入資料。請按『載入/更新資料』。");});
</script>
